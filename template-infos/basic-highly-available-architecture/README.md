## **方案概览**

业务的持续稳定可服务，决定着企业对客户的服务质量，是企业发展的基础。而应用部署的高可用架构对于业务的稳定与发展起着至关重要的作用，本方案从企业上云最基础的需求出发，面向可能遇到的单点故障风险，介绍了“业务上云高可用架构”方案设计，为您演示：

* 如何搭建一个跨可用区的高可用架构系统
* 搭建完成后，通过模拟故障，观察网站的可用性

## **方案架构**

本架构采用单地域双可用区部署，将业务系统、数据库部署在2个不同可用区，实现了可用区级故障灾备能力，从而保证了业务的连续性。同时，该架构还利用专有网络VPC、交换机和跨可用区安全组等基础设施，实现了私有网络下的系统通信。

方案提供的默认设置完成部署后在阿里云上搭建的高可用架构如下图所示。实际部署时您可以根据资源规划修改部分设置，但最终形成的运行环境与下图相似。

![image](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/4500937171/p806800.png)

本方案的技术架构包括以下基础设施和云服务：

* 1个专有网络VPC：为应用型负载均衡ALB、云服务器ECS、云数据库RDS等云资源构建云上私有网络。
* 6台交换机：按照经典架构设计3个子网平面（公网平面、业务平面、数据平面），分别部署在两个可用区，提供基本的网络分段和隔离功能。ALB横跨两个可用区部署在公网平面，两台ECS分别部署在两个可用区的业务平面，一对云数据库RDS MySQL高可用版主备节点分别部署在两个可用区的数据平面。
* 1个公网应用型负载均衡ALB：将公网访问流量分发到不同云服务器ECS，支持配置后端服务器组自动弹性伸缩。公网ALB通过EIP提供公网服务能力。
* 2台云服务器ECS：用于部署业务系统，提供应用服务。
* 1个云数据库RDS MySQL高可用版：为业务系统提供数据服务。
## **方案部署**
### **部署准备**


开始部署前，请按以下指引完成账号申请、账号充值。

### **准备账号**

1. 如果您还没有阿里云账号，请访问[阿里云账号注册页面](https://account.aliyun.com/register/qr_register.htm)，根据页面提示完成注册。阿里云账号是您使用云资源的付费实体，因此是部署方案的必要前提。
2. [为阿里云账号充值](https://help.aliyun.com/document_detail/324650.html)。本方案的云资源支持按量付费，且默认设置均采用按量付费引导操作。如果确定任何一个云资源采用按量付费方式部署，账户余额都必须大于等于100元。


一键部署基于阿里云资源编排服务ROS（Resource Orchestration Service）实现，模板是描述基础设施和架构的蓝图，通过ROS模板可自动化地完成云资源的创建和配置，提高资源的创建和部署效率。本方案提供的ROS模板完成资源的创建和配置内容包括：

* 创建2台云服务器ECS实例，以实现服务跨可用区的高可用。
* 创建1个专有网络VPC。
* 创建6台交换机，为了实现高可用，您需要将云服务器等资源尽可能分布在多个可用区，规避单可用区故障造成的服务不可用。
* 创建1个高可用的云数据库RDS MySQL。
* 创建1个公网类型的应用型负载均衡ALB并配置服务器组和监听，从而实现这个专有网络VPC下的2台云服务器ECS对外的公网访问和流量分发。

### 一键部署

1. 打开[一键部署模板链接](https://ros.console.aliyun.com/region/stacks/create?templateUrl=https://ros-public-templates.oss-cn-hangzhou.aliyuncs.com/service_template/technical-solution/basic-highly-available-architecture.yml&hideStepRow=true&hideStackConfig=true&pageTitle=云上高可用架构&disableRollback=false&isSimplified=true&disabltion=true&productNavBar=disabled&balanceIntercept=true)前往ROS控制台，系统自动打开使用新资源创建资源栈的面板。
   
   **说明** 
   
   ROS控制台默认处于您上一次访问控制台时的地域，请根据您创建的资源所在地域修改地域后再执行下一步。
2. 在**配置参数**页面完成以下配置（本教程以**华东1（杭州）**为例）后，单击**下一步：检查并确认**。
   
   | 配置项 | 参数 | 说明 | 示例值 |
   | --- | --- | --- | --- |
   | ECS配置 | 可用区 | 为每个ECS实例选择一个可用区，并确保两个ECS实例位于不同的可用区。 | 可用区 J、可用区 K |
   | 实例规格 | 根据ECS实例的架构、分类选择相应的规格配置。 | `ecs.e-c1m2.large` |
   | 实例密码 | ECS实例账号的密码。 | |
   | RDS 数据库配置 | RDS实例规格 | 云数据库RDS实例的规格。 | `mysql.x2.medium.2c` |
   | RDS数据库账号 | PolarDB MySQL实例的数据库账号和密码。 | |
   | RDS数据库密码 |
   | 其他配置 | 是否开通 CDT | 开通成功后需继续将云产品升级至CDT计费，赠送200 GB/月公网流量，其中20 GB/月可用于全球地域（含中国内地），180 GB/月仅限非中国内地地域使用，可抵扣云服务器ECS、弹性公网IP等按流量计费实例产生的公网流量，超出部分采用阶梯计费。 | 自定义。 |
3. 在资源配置预览页面，确认模板参数以及费用之后，单击**创建**。
4. 当**资源栈信息**页面的**状态**显示为**创建成功**时表示一键配置完成。
### **验证及清理**


#### 方案验证

**一、通过访问ALB的DNS名称，验证服务可用性**

1. 登录[ALB控制台](https://slb.console.aliyun.com/alb)，从实例列表中获取ALB实例的DNS名称。![image](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/1375047271/p854661.png)
2. 通过浏览器访问该DNS名称，检查是否可以正常访问到示例应用。若页面显示如下图所示内容，则表明服务已经成功启动并处于正常运行状态。![image (1)](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/1375047271/p854663.png)

**二、通过ECS停机模拟服务器故障，验证服务高可用**

完成多服务器配置后，可以通过停止任一服务器来模拟故障情况，以验证在部分服务器不可用时服务的可用性。

1. 登录[ECS管理控制台](https://ecs.console.aliyun.com/)。在左侧导航栏，选择**实例与镜像>实例**。在顶部菜单栏，选择与实例相同的地域。
2. 从列表中选择任意一个ECS实例，在其右侧操作列中点击**更多>实例状态>停止**。在弹出的**停止实例**页面中，选择**普通停机模式**，然后单击**确定**。![image](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/1542902371/p862036.png)
3. 等待实例状态变为**已停止**，再次通过浏览器访问ALB实例的DNS名称，确认服务仍然可以正常访问。打开[应用型负载均衡（ALB）控制台](https://slb.console.aliyun.com/alb/cn-hangzhou/albs)，点击相应的实例ID进入详情页面，再点击**监控图表**，查看**健康检查**。此时可以观察到负载均衡实例的健康服务器数量从两台减少为一台。![image (3)](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/1375047271/p854680.png)

上述步骤能够验证负载均衡ALB的正确性和可靠性，确保即使在出现故障的情况下，系统仍能稳定运行并提供高可用的服务。

**三、通过主备切换，验证数据库高可用**

1. 访问[RDS实例列表](https://rdsnext.console.aliyun.com/rdsList/basic?spm=a2c4g.2785364.0.0.620668afFIQKOX)，在顶部选择相应的地域，然后点击实例的ID进入详情页面。
2. 在**基本信息**页面，查看并记录当前主数据库和备用数据库所在的可用区。![image (4)](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/1375047271/p854690.png)
3. 在左侧导航栏中，选择**服务可用性**，在**实例可用性**区域，点击**主备库切换**。在弹出的对话框中选择**立即切换**，然后单击**确定**以执行切换操作。![image](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/1375047271/p854691.png)
4. 待主备状态在可用区间完成切换后，通过浏览器访问应用程序负载均衡器（ALB）实例的DNS名称，确认服务仍然可以正常访问。再次查看RDS实例的**基本信息**页面，此时可以观察到主数据库与备用数据库所在的可用区已经互换位置。![image (1)](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/1375047271/p854692.png)

以上步骤验证了RDS实例的高可用性配置能够确保在主备切换过程中服务连续性不受影响，并且数据的一致性和可靠性得到保障。

#### 清理资源

您可以使用ROS一键删除创建的云资源，避免继续产生费用。

1. 登录[ROS控制台](https://ros.console.aliyun.com/overview)。
2. 在左侧导航栏，选择**资源栈**。
3. 在**资源栈**页面的顶部选择部署的资源栈所在地域，找到资源栈，然后在其右侧**操作**列，单击**删除**。
4. 在**删除资源栈**对话框，选择**删除方式**为**释放资源**，然后单击**确定**，根据提示完成资源释放。
