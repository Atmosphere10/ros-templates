ROSTemplateFormatVersion: '2015-09-01'
Parameters:
  AccelerateRegionId:
    Type: String
    Label:
      en: Accelerate region ID.
      zh-cn: 加速地域ID。
    Description:
      zh-cn: 该模板不支持跨境网络（中国内地的地域与中国香港、中国澳门、中国台湾地域或其他国家和地区）加速。业务涉及跨境网络时，您可以选择中国香港作为加速地域或终端节点地域。
      en: This template does not support cross-border network acceleration. When your business involves cross-border networks, you can choose Hong Kong, China as the acceleration region or terminal node region.
    AssociationProperty: ALIYUN::ECS::RegionId
    Default: cn-hongkong
  EndpointGroupRegion:
    Type: String
    Label:
      en: Endpoint group region ID.
      zh-cn: 终端节点所在的地域ID。
    AssociationProperty: ALIYUN::ECS::RegionId
    Default: us-west-1
  EndpointIPs:
    Type: Json
    Label:
      en: Endpoint ip list.
      zh-cn: 终端节点IP。
    AssociationProperty: List[Parameter]
    AssociationPropertyMetadata:
      Parameter:
        Type: String
    MinLength: 2
    MaxLength: 2
Resources:
  Accelerator:
    Type: ALIYUN::GA::Accelerator
    Properties:
      BandwidthBillingType: CDT
      InstanceChargeType: PayAsYouGo
  AccelerateRegion:
    Type: ALIYUN::GA::IpSets
    Properties:
      AcceleratorId:
        Ref: Accelerator
      AccelerateRegion:
      - Bandwidth: 2
        IpVersion: IPv4
        AccelerateRegionId:
          Ref: AccelerateRegionId
        IspType: BGP
  Listener:
    Type: ALIYUN::GA::Listener
    Properties:
      PortRanges:
      - FromPort: 80
        ToPort: 80
      Protocol: tcp
      AcceleratorId:
        Ref: Accelerator
      ClientAffinity: SOURCE_IP
    DependsOn: AccelerateRegion
  EndpointGroup:
    Type: ALIYUN::GA::EndpointGroup
    Properties:
      EndpointGroupRegion:
        Ref: EndpointGroupRegion
      AcceleratorId:
        Ref: Accelerator
      ListenerId:
        Ref: Listener
      EndpointConfigurations:
      - Type: Ip
        Weight: 10
        Endpoint:
          Fn::Select:
          - 0
          - Ref: EndpointIPs
      - Type: Ip
        Weight: 40
        Endpoint:
          Fn::Select:
          - 1
          - Ref: EndpointIPs
Outputs:
  AcceleratorId:
    Description:
      en: The ID of the Global Accelerator instance
      zh-cn: 全球加速实例ID
    Value:
      Fn::GetAtt:
      - Accelerator
      - AcceleratorId
  EndpointGroupId:
    Description:
      en: The ID of the endpoint group
      zh-cn: 终端节点ID
    Value:
      Fn::GetAtt:
      - EndpointGroup
      - EndpointGroupId
  ListenerId:
    Description:
      en: The ID of the listener
      zh-cn: 监听ID
    Value:
      Fn::GetAtt:
      - Listener
      - ListenerId
Metadata:
  ALIYUN::ROS::Interface:
    ParameterGroups:
    - Parameters:
      - AccelerateRegionId
      Label:
        default:
          en: AccelerateRegion
          zh-cn: 加速地域
    - Parameters:
      - EndpointGroupRegion
      - EndpointIPs
      Label:
        default:
          en: EndpointGroup
          zh-cn: 终端节点
    TemplateTags:
    - acs:document-help:ga:加速访问指定IP的后端服务
