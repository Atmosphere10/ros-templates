ROSTemplateFormatVersion: '2015-09-01'
Description:
  zh-cn: 创建可选新或用已有ECS实例，配置VPC、安全组及云盘，自动安装LNMP环境，提供外部访问URL。
  en: Create a new or optional existing Elastic Compute Service (ECS) instance, configure
    Virtual Private Cloud (VPC), security groups, and cloud disks, automatically install
    the LNMP stack, and provide an external access URL.
Parameters:
  InstanceSource:
    Type: String
    Default: CreateNew
    Label:
      zh-cn: 实例来源
      en: Instance Source
    AllowedValues:
      - CreateNew
      - UseExisted
    AssociationPropertyMetadata:
      ValueLabelMapping:
        CreateNew:
          zh-cn: 创建新实例
          en: Create New Instance
        UseExisted:
          zh-cn: 选择已有实例
          en: Select Existed Instance
  ZoneId:
    Type: String
    Default: null
    Required: true
    Label:
      en: Availability Zone
      zh-cn: 可用区
    AssociationProperty: ALIYUN::ECS::Instance::ZoneId
    AssociationPropertyMetadata:
      AutoSelectFirst: true
      Visible:
        Condition:
          Fn::Equals:
            - ${InstanceSource}
            - CreateNew
  ImageId:
    Type: String
    Default: aliyun_3_9_x64_20G_alibase_20231219.vhd
    Required: true
    Label:
      en: Image of Instance
      zh-cn: 实例镜像
    AssociationProperty: ALIYUN::ECS::Image::ImageId
    AssociationPropertyMetadata:
      SupportedImageOwnerAlias:
        - system
      IsSupportCloudinit: true
      Visible:
        Condition:
          Fn::Equals:
            - ${InstanceSource}
            - CreateNew
  InstanceType:
    Type: String
    Default: null
    Required: true
    Label:
      en: Instance Type
      zh-cn: 实例类型
    AssociationProperty: ALIYUN::ECS::Instance::InstanceType
    AssociationPropertyMetadata:
      ZoneId: ${ZoneId}
      SpotStrategy: SpotAsPriceGo
      InstanceChargeType: PostPaid
      SystemDiskCategory: cloud_essd
      Visible:
        Condition:
          Fn::Equals:
            - ${InstanceSource}
            - CreateNew
  InstancePassword:
    Type: String
    NoEcho: true
    Default: null
    Confirm: true
    Description:
      en: >-
        Server login password, Length 8-30, must contain three(Capital letters,
        lowercase letters, numbers, ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ Special
        symbol in)
      zh-cn: >-
        服务器登录密码,长度8-30，必须包含三项（大写字母、小写字母、数字、 ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/
        中的特殊符号）
    Label:
      en: Instance Password
      zh-cn: 实例密码
    ConstraintDescription:
      en: >-
        Length 8-30, must contain three(Capital letters, lowercase letters,
        numbers, ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ Special symbol in)
      zh-cn: '长度8-30，必须包含三项（大写字母、小写字母、数字、 ()`~!@#$%^&*_-+=|{}[]:;''<>,.?/ 中的特殊符号）'
    AssociationProperty: 'ALIYUN::ECS::Instance::Password'
    AssociationPropertyMetadata:
      Visible:
        Condition:
          Fn::Equals:
            - ${InstanceSource}
            - CreateNew
  EcsInstanceId:
    Type: String
    Default: null
    Label:
      en: ECS Instance ID
      zh-cn: ECS实例ID
    AssociationProperty: ALIYUN::ECS::Instance::InstanceId
    AssociationPropertyMetadata:
      Status: Running
      Visible:
        Condition:
          Fn::Equals:
            - ${InstanceSource}
            - UseExisted
  CommonName:
    Type: String
    Default: lnmp
Conditions:
  CreateInstance:
    Fn::Equals:
      - Ref: InstanceSource
      - CreateNew
  UseExistedInstance:
    Fn::Equals:
      - Ref: InstanceSource
      - UseExisted
Resources:
  Vpc:
    Type: 'ALIYUN::ECS::VPC'
    Condition: CreateInstance
    Properties:
      CidrBlock: 192.168.0.0/16
      VpcName:
        Fn::Sub: ${CommonName}-vpc
  VSwitch:
    Type: 'ALIYUN::ECS::VSwitch'
    Condition: CreateInstance
    Properties:
      VpcId:
        Ref: Vpc
      CidrBlock: 192.168.0.0/24
      ZoneId:
        Ref: ZoneId
      VSwitchName:
        Fn::Sub: ${CommonName}-vsw
  SecurityGroup:
    Type: 'ALIYUN::ECS::SecurityGroup'
    Condition: CreateInstance
    Properties:
      VpcId:
        Ref: Vpc
      SecurityGroupName:
        Fn::Sub: ${CommonName}-sg
      SecurityGroupIngress:
        - PortRange: 3389/3389
          SourceCidrIp: 0.0.0.0/0
          IpProtocol: tcp
        - PortRange: 80/80
          SourceCidrIp: 0.0.0.0/0
          IpProtocol: tcp
        - PortRange: '-1/-1'
          SourceCidrIp: 0.0.0.0/0
          IpProtocol: icmp
  EcsInstance:
    Type: 'ALIYUN::ECS::InstanceGroup'
    Condition: CreateInstance
    Properties:
      VpcId:
        Ref: Vpc
      ZoneId:
        Ref: ZoneId
      VSwitchId:
        Ref: VSwitch
      SecurityGroupId:
        Ref: SecurityGroup
      ImageId:
        Ref: ImageId
      InstanceName:
        Fn::Sub: ${CommonName}-ecs
      InstanceType:
        Ref: InstanceType
      SystemDiskCategory: cloud_essd
      MaxAmount: 1
      InternetMaxBandwidthOut: 100
      SpotStrategy: SpotAsPriceGo
      Password:
        Ref: InstancePassword
  ModuleInstallLNMP:
    Version: default
    Type: 'MODULE::ACS::OOS::Extension'
    Properties:
      EcsInstanceIds:
        - Fn::If:
            - UseExistedInstance
            - Ref: EcsInstanceId
            - Ref: EcsInstance
      PackageName: ACS-Extension-LNMP-One-Click-1853370294850618
  DsEcs:
    Type: 'DATASOURCE::ECS::Instances'
    Properties:
      InstanceIds:
        - Fn::If:
            - UseExistedInstance
            - Ref: EcsInstanceId
            - Ref: EcsInstance
Outputs:
  EcsLoginAddress:
    Description:
      en: Ecs login address.
      zh-cn: ECS登录地址。
    Value:
      Fn::Sub:
        - https://ecs-workbench.aliyun.com/?from=EcsConsole&instanceType=ecs&regionId=${ALIYUN::Region}&instanceId=${InstanceId}
        - InstanceId:
            Fn::If:
              - UseExistedInstance
              - Ref: EcsInstanceId
              - Ref: EcsInstance
  NginxUrl:
    Description:
      en: Nginx Info Page.
      zh-cn: Nginx信息页面。
    Value:
      Fn::Sub:
        - http://${PublicIp}
        - PublicIp:
            Fn::Jq:
              - First
              - if .[0].PublicIpAddress != [] then .[0].PublicIpAddress[0] else .[0].EipAddress.IpAddress end
              - Fn::GetAtt:
                  - DsEcs
                  - Instances
  PhpUrl:
    Description:
      en: PHP Info Page.
      zh-cn: PHP信息页面。
    Value:
      Fn::Sub:
      - http://${PublicIp}/phpinfo.php
      - PublicIp:
          Fn::Jq:
          - First
          - if .[0].PublicIpAddress != [] then .[0].PublicIpAddress[0] else .[0].EipAddress.IpAddress
            end
          - Fn::GetAtt:
            - DsEcs
            - Instances
Metadata:
  ALIYUN::ROS::Interface:
    ParameterGroups:
      - Parameters:
          - InstanceSource
          - ZoneId
          - ImageId
          - InstanceType
          - InstancePassword
          - EcsInstanceId
    Hidden:
      - CommonName
    TemplateTags:
      - acs:document-help:ecs:部署LNMP环境
  ALIYUN::ROS::Composer:
    '18392978':
      Res:
        - ZoneId
      Parent: e50a6770
      Rect:
        - 440
        - 270
        - 100
        - 250
        - 4
        - 0
      ResT: Composer::ROSParameter::Zone
    7c4edf08:
      Rect:
        - 620
        - 572
        - 40
        - 100
        - 1
        - 0
      ResT: Composer::ROSParameter::AlibabaCloud
    42a1cef6:
      Parent: 7c4edf08
      Rect:
        - 580
        - 506
        - 60
        - 150
        - 2
        - 0
      ResT: Composer::ROSParameter::Region
    e50a6770:
      Res:
        - Vpc
      Parent: 42a1cef6
      Rect:
        - 480
        - 340
        - 80
        - 200
        - 3
        - 0
    cf53e8a2:
      Parent: 42a1cef6
      Rect:
        - 40
        - 40
        - 210
        - 570
        - 3
        - 0
      ResT: MODULE::ACS::OOS::Extension
    7eec08ec:
      Parent: 42a1cef6
      Rect:
        - 40
        - 40
        - 403
        - 570
        - 3
        - 0
      ResT: DATASOURCE::ECS::Instances
    acd5303c:
      Res:
        - VSwitch
      Parent: '18392978'
      Rect:
        - 400
        - 200
        - 120
        - 300
        - 5
        - 0
    3d0285d5:
      Res:
        - SecurityGroup
      Parent: e50a6770
      Rect:
        - 153
        - 112
        - 250
        - 350
        - 10
        - 0
    cdd32e3e:
      Parent: 42a1cef6
      Edge:
        - cf53e8a2
        - 8cd1dcb0
      Line: 0:0:0:gray:0
    46fee1f6:
      Parent: 42a1cef6
      Edge:
        - 7eec08ec
        - 8cd1dcb0
      Line: 0:0:0:gray:0
    8cd1dcb0:
      Res:
        - EcsInstance
      Parent: acd5303c
      Rect:
        - 40
        - 40
        - 312
        - 380
        - 11
        - 0
      Layer:
        - 3d0285d5

